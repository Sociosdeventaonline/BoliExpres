<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BOLIS - Tienda de Bolis de Hielo</title>
<link href="https://fonts.googleapis.com/css2?family=Chewy&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">

  <style>

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f7fb;
      margin: 0;
      padding: 0;
      color: #1c2b33;
    }
.carrito {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100vw;
  max-width: 100%;
  z-index: 999;
  background-color: #ffffff;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  padding: 20px;
  box-sizing: border-box;

  max-height: 60vh;  /* M√°ximo 60% de altura de la pantalla */
  overflow-y: auto;  /* Desplazable si el contenido se desborda */
}

body {
  padding-bottom: 260px;  /* Espacio para el carrito fijo */
  overflow-x: hidden;
  margin: 0;
}

.tabla-responsive {
  overflow-x: auto;
  width: 100%;
}

    header {
      background-color: #ffffff;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      position: relative;
    }
    header h1 {
      margin: 0;
      color: #124559;
    }
    nav button {
      background-color: #2a9d8f;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1em;
      cursor: pointer;
    }
    .login-container, .admin-panel {
      text-align: center;
      padding: 20px;
    }
    .productos {
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .producto {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 200px;
    }
    .producto img {
      height: 100px;
      margin-bottom: 10px;
    }
    .agotado {
      opacity: 0.5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .total {
      text-align: right;
      font-size: 1.2em;
    }
    .finalizar, .logout-btn {
      text-align: right;
      padding: 20px;
    }
#inventarioInputs {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
  margin-top: 10px;
}
#inventarioInputs label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}
#inventarioInputs input {
  width: 60px;
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: center;
}
/* Estilos para men√∫ hamburguesa en m√≥vil */
.hamburguesa {
  display: none;
  font-size: 2em;
  background: none;
  border: none;
  color: #1e40af;
  cursor: pointer;
  margin-left: 20px;
}

.menu-movil {
  display: none;
  position: absolute;
  top: 80px;
  left: 20px;
  background-color: #ffffff;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  z-index: 999;
  flex-direction: column;
  gap: 10px;
}

/* Mostrar hamburguesa solo en pantallas peque√±as */
@media (max-width: 768px) {
  .hamburguesa {
    display: block;
  }

  nav {
    display: none !important;
  }

  .menu-movil {
    display: flex;
  }
}
/* Oculta el bot√≥n de escritorio en m√≥viles */
@media only screen and (max-width: 768px) {
  #logoutContainer {
    display: none !important;
  }
}

/* Oculta el bot√≥n m√≥vil en pantallas grandes */
@media only screen and (min-width: 769px) {
  #logoutContainerMovil {
    display: none !important;
  }
}
.instrucciones {
  background: linear-gradient(to right, #e0f7fa, #fff);
  padding: 40px 20px;
  text-align: center;
  border-bottom: 2px solid #d0d7de;
}
.instrucciones h2 {
  font-size: 2em;
  color: #124559;
  margin-bottom: 30px;
}
.pasos {
  display: flex;
  justify-content: center;
  gap: 30px;
  flex-wrap: wrap;
}
.paso {
  max-width: 200px;
  background-color: #ffffff;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.paso img {
  width: 100px;
  height: auto;
  margin-bottom: 15px;
}
.paso p {
  font-size: 0.95em;
  color: #1c2b33;
  margin: 0;
}

.boton-agregar {
  background-color: #1e3a8a; /* azul fuerte */
  color: #ffffff; /* texto blanco */
  padding: 6px 12px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.boton-agregar:hover {
  background-color: #3b82f6; /* azul m√°s claro al pasar el mouse */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.boton-agregar:active {
  transform: scale(0.96); /* efecto de "clic" presionado */
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}
.contenedor-pasos {
  display: flex;
  overflow-x: auto;
  gap: 16px;
  padding: 10px 16px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  margin-bottom: 24px;
}

.paso {
  flex: 0 0 auto;
  width: 220px;
  background-color: #ffffff;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  scroll-snap-align: start;
}

.paso img {
  width: 60px;
  margin-bottom: 10px;
}

.titulo-bolis {
  font-family: ''Fredoka', cursive;
  font-size: 1.8em;
  text-align: center;
  background: linear-gradient(to right, #a2d4f2, #fdd1da);
  padding: 12px 24px;
  border-radius: 18px;
  display: inline-block;
  color: #1c2b33;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  margin: 0 auto 20px auto;
}

.pasos-flex {
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.paso-item {
  background-color: #ffffff;
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  padding: 12px;
  text-align: center;
  width: 160px;
}

.paso-item img {
  width: 70px;
  height: auto;
  margin-bottom: 10px;
}

.scroll-horizontal {
  display: flex;
  overflow-x: auto;
  gap: 16px;
  padding: 12px 0;
  scroll-snap-type: x mandatory;
}

.scroll-horizontal::-webkit-scrollbar {
  display: none; /* Oculta la barra horizontal */
}

.paso-item {
  flex: 0 0 auto;
  width: 240px;
  background-color: #ffffff;
  border-radius: 16px;
  padding: 12px; /* antes 16px, ahora menos */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
  scroll-snap-align: center;
  text-align: center;
  min-height: auto; /* quita la altura m√≠nima */
}
.paso-item p {
  margin-bottom: 0;
}
.paso-item img {
  max-width: 80px;
  margin-bottom: 8px; /* en vez de 12px */
}
.paso-item img {
  max-width: 80px;
  margin-bottom: 12px;
}

#editorPublicidad input[type="text"],
#editorPublicidad textarea,
#editorPublicidad input[type="file"] {
  width: 100%;
  padding: 10px;
  margin-bottom: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  box-sizing: border-box;
}

#editorPublicidad button {
  background-color: #1e3a8a;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
}

#editorPublicidad button:hover {
  background-color: #3b82f6;
}

#popupPublicidad {
  display: none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 450px;
  background-image: url('fondo_publicidad.png'); /* tu fondo decorativo */
  background-size: cover;
  background-position: center;
  border-radius: 20px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
  z-index: 9999;
  padding: 20px;
  color: #1c2b33;
  text-align: center;
}

#popupPublicidad h2 {
  font-size: 1.5em;
  margin-bottom: 8px;
}

#popupPublicidad h3 {
  margin-top: 8px;
  font-size: 1.2em;
  color: #124559;
}

#popupPublicidad p {
  font-size: 1em;
  color: #333;
}

#popupPublicidad img {
  width: 100%;
  max-height: 200px;
  object-fit: contain;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#popupPublicidad h2,
#popupPublicidad h3 {
  font-family: 'Chewy', 'Fredoka', cursive;
  font-weight: normal;
  color: white;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  letter-spacing: 1px;
}





  </style>
</head>
<body onload="verificarSesion()">
  <header>
<img src="Boliexpres.png" alt="Logo BoliExpres" style="height: 80px; margin-left: 20px;">
<button class="hamburguesa" onclick="toggleMenu()">‚ò∞</button>
  <nav style="display: flex; gap: 10px; align-items: center; position: absolute; top: 20px; right: 140px;">
    <div id="historialBoton" style="display:none;">
      <button onclick="mostrarHistorialVentas()" style="background-color:#1e40af; color:white; padding:10px 20px; border:none; border-radius:5px; font-size:1em;">
        H ventas
      </button>
    </div>
    <button onclick="toggleLogin()" style="background-color:#1e40af; color:white; padding:10px 20px; border:none; border-radius:5px; font-size:1em;">
      Vendedor
    </button>
  </nav>
<div id="menuMovil" class="menu-movil" style="display: none;">
  <button onclick="toggleLogin(); toggleMenu()">Vendedor</button>
  <div id="historialBotonMovil" style="display:none;">
    <button onclick="mostrarHistorialVentas(); toggleMenu()">H ventas</button>
 </div>
<div id="publicidadBotonMovil" style="display:none;">
  <button onclick="togglePublicidad(); toggleMenu()">Publicidad</button>
</div>
  <div id="logoutContainerMovil" style="display:none;">
    <button onclick="cerrarSesion(); toggleMenu()">Cerrar sesi√≥n</button>
  </div>
</div>
</header>

  <div class="login-container" id="loginContainer" style="display:none;">
    <h2>Iniciar Sesi√≥n</h2>
    <input type="text" id="usuario" placeholder="Usuario"><br><br>
    <input type="password" id="contrasena" placeholder="Contrase√±a"><br><br>
    <button onclick="iniciarSesion()">Ingresar</button>
  </div>

  <div class="logout-btn" id="logoutContainer" style="display:none;">
    <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
  </div>



  <div class="admin-panel" id="adminPanel" style="display:none;">
    <h2>Panel del Vendedor</h2>
    <h3>Ventas del d√≠a</h3>
    <table id="tablaVentas">
      <thead><tr><th>Producto</th><th>Precio</th><th>Cantidad</th><th>Subtotal</th></tr></thead>
      <tbody></tbody>
    </table>
    <h3>Inventario disponible</h3>
    <div id="inventarioInputs"></div>
    <button onclick="guardarInventario()">Guardar inventario</button>
<button onclick="togglePublicidad()">Mostrar/Ocultar Publicidad</button>

<div id="editorPublicidad" style="display: none; max-width: 500px; margin: 30px auto; background: #ffffff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center;">
  <h3>Editar Publicidad</h3>
  <input type="text" id="tituloPublicidad" placeholder="T√≠tulo"><br><br>
  <textarea id="descripcionPublicidad" placeholder="Descripci√≥n corta" rows="3" style="width:100%;"></textarea><br><br>
  <input type="text" id="precioPublicidad" placeholder="Precio"><br><br>
  <input type="file" id="imagenesPublicidad" multiple><br><br>
  <button onclick="guardarPublicidad()">Guardar Publicidad</button>
</div>

  </div>

<section class="instrucciones">
  <h2 class="titulo-bolis">¬øC√≥mo comprar tus bolis? üçß</h2>
<div class="pasos-flex scroll-horizontal">
    <div class="paso-item">
      <img src="cubohielo1.png" alt="Paso 1">
      <p><strong>Paso 1:</strong><br> Elige tus sabores y da clic en <em>‚ÄúA√±adir al carrito‚Äù</em>.</p>
    </div>
    <div class="paso-item">
      <img src="cubohielo2.png" alt="Paso 2">
      <p><strong>Paso 2:</strong><br> Da clic en <em>‚ÄúFinalizar compra‚Äù</em> y paga.</p>
    </div>
    <div class="paso-item">
      <img src="cubohielo3.png" alt="Paso 3">
      <p><strong>Paso 3:</strong><br> Toma tu boli del <em>refri congelador</em>. ‚ùÑÔ∏è</p>
    </div>
  </div>
</section>





  <section class="productos" id="productos"></section>

<section class="carrito">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
    <button onclick="finalizarCompra()" style="background: linear-gradient(to right, #f43f5e, #fb7185); color: white; padding: 12px 24px; border: none; border-radius: 30px; font-size: 1em; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s;">
      Finalizar compra üçß
    </button>
    <div class="total" style="font-weight: bold; font-size: 1.2em;">Total: $<span id="total">0.00</span></div>
  </div>

  <h2>Carrito</h2>
  <div class="tabla-responsive">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th></th> <!-- para el bot√≥n eliminar -->
        </tr>
      </thead>
      <tbody id="itemsCarrito"></tbody>
    </table>
  </div>
</section>




<!-- Secci√≥n de historial de ventas -->
<div id="historialVentas" style="display:none; padding:20px;">
  <h2>Historial de Ventas</h2>
  <input type="text" id="filtroBusqueda" oninput="filtrarHistorial()" placeholder="Buscar por nombre, forma de pago o fecha" style="padding:5px; width:100%; margin-bottom:10px;"/>
<div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
<label>Desde:
  <input type="date" id="fechaInicio"
         oninput="filtrarPorFechas()" onchange="filtrarPorFechas()">
</label>
<label>Hasta:
  <input type="date" id="fechaFin"
         oninput="filtrarPorFechas()" onchange="filtrarPorFechas()">
</label>
</div>

  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#f0f0f0;">
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Celular</th>
        <th>Forma de Pago</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Subtotal</th>
        <th>Estatus</th>
        <th>Estatus Entrega</th> <!-- NUEVA COLUMNA -->
      </tr>
    </thead>
    <tbody id="tablaHistorialBody"></tbody>
  </table>

<div id="resumenTotales" style="margin-top: 10px; text-align: right; font-weight: bold;">
  Total productos vendidos: <span id="totalProductosVendidos">0</span><br>
  Dinero ingresado: $<span id="dineroIngresado">0.00</span>
</div>

</div>



<script>
// === NUEVO: control por defecto "solo hoy" ===
let soloHoyPorDefecto = true;

function hoyYYYYMMDD() {
  return new Date().toISOString().slice(0, 10); // YYYY-MM-DD
}

// Convierte "dd/mm/aaaa, hh:mm:ss" a "YYYY-MM-DD"
function fechaTextoAISO(fechaTexto) {
  // Ej: "21/08/2025, 15:12:33"
  if (!fechaTexto) return '';
  const partes = fechaTexto.split(',');
  const soloFecha = partes[0]?.trim() || '';
  const [dd, mm, yyyy] = soloFecha.split('/').map(s => s.trim());
  if (!dd || !mm || !yyyy) return '';
  const dd2 = dd.padStart(2, '0');
  const mm2 = mm.padStart(2, '0');
  return `${yyyy}-${mm2}-${dd2}`;
}



const sabores = [
  { nombre: 'Boli de Fresa', imagen: 'fresa_con_crema.png' },
  { nombre: 'Boli de Mango con Chamoy', imagen: 'mango_con_chamoy.png' },
  { nombre: 'Boli de Sand√≠a con Chamoy', imagen: 'sandia_con_chamoy.png' },
  { nombre: 'Boli de Pi√±a con Chamoy', imagen: 'pina_con_chamoy.png' },
  { nombre: 'Boli de Oreo', imagen: 'oreo.png' },
  { nombre: 'Boli de Duval√≠n', imagen: 'duvalin.png' },
  { nombre: 'Boli de Pica Fresa', imagen: 'picafresa.png' },
  { nombre: 'Boli de Pay de limon', imagen: 'tamarindo.png' },
  { nombre: 'Boli de Jamaica', imagen: 'jamaica.png' } // üëà NUEVO
  ];
    const inventario = {};
    const carrito = [];
    const ventas = [];

    function renderProductos() {
      const contenedor = document.getElementById('productos');
      contenedor.innerHTML = '';
      sabores.forEach(({ nombre, imagen }) => {
        const stock = inventario[nombre] ?? 0;
        const agotado = stock <= 0;
contenedor.innerHTML += `
  <div class="producto ${agotado ? 'agotado' : ''}" style="position: relative;">
    <div style="position: absolute; top: 8px; left: 8px; background-color: #ffedd5; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; color: #92400e; font-weight: bold;">
      Pz disponibles: ${stock}
    </div>
    <img src="${imagen}" alt="${nombre}">
    <h3>${nombre} - $16.00</h3>
${agotado ? '<strong>AGOTADO</strong>' : `<button class="boton-agregar" onclick="agregarAlCarrito('${nombre}', 16)">A√ëADIR AL CARRITO</button>`}
  </div>
`;

      });
    }

    function agregarAlCarrito(nombre, precio) {
      if (inventario[nombre] <= 0) return;
      const index = carrito.findIndex(i => i.nombre === nombre);
      if (index >= 0) carrito[index].cantidad++;
      else carrito.push({ nombre, precio, cantidad: 1 });
      inventario[nombre]--;
      actualizarCarrito();
      renderProductos();

  // Guarda despu√©s de actualizar
  localStorage.setItem('carritoBolis', JSON.stringify(carrito));
}
function actualizarCarrito() {
  const items = document.getElementById('itemsCarrito');
  const totalElem = document.getElementById('total');
  items.innerHTML = '';
  let total = 0;

  carrito.forEach((item, index) => {
    const subtotal = item.precio * item.cantidad;
    total += subtotal;

    items.innerHTML += `
      <tr>
        <td>${item.nombre}</td>
        <td>$${item.precio}</td>
        <td>${item.cantidad}</td>
        <td>$${subtotal.toFixed(2)}</td>
        <td>
          <button onclick="eliminarDelCarrito(${index})" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px;">
            Eliminar
          </button>
        </td>
      </tr>
    `;
  });

  totalElem.textContent = total.toFixed(2);
}
function eliminarDelCarrito(index) {
  const item = carrito[index];
  if (!item) return;

  // Regresa la cantidad al inventario
  inventario[item.nombre] += item.cantidad;

  // Elimina el producto del carrito
  carrito.splice(index, 1);

  // Guarda el carrito actualizado
  localStorage.setItem('carritoBolis', JSON.stringify(carrito));

  // Refresca las vistas
  actualizarCarrito();
  renderProductos();
}


let datosCliente = {};

function finalizarCompra() {
  const nombre = prompt("¬øCu√°l es tu nombre completo?");
  const celular = prompt("¬øCu√°l es tu n√∫mero de contacto?");
  if (!nombre || !celular) {
    alert("Por favor ingresa tu nombre y n√∫mero.");
    return;
  }

  datosCliente.nombre = nombre;
  datosCliente.celular = celular;

  // Mostrar el modal
  document.getElementById('metodoPagoModal').style.display = 'flex';
}
function pagarTransferencia() {
  document.getElementById('metodoPagoModal').style.display = 'none';

  let detallePedido = '';
  carrito.forEach(i => {
    detallePedido += `- ${i.cantidad} x ${i.nombre} ($${i.precio})\n`;

    const refItem = firebaseRef(firebaseDB, `inventario/${i.nombre}`);
    firebaseGet(refItem).then(snapshot => {
      if (snapshot.exists()) {
        const actual = parseInt(snapshot.val()) || 0;
        const nuevoStock = Math.max(0, actual - i.cantidad);
        inventario[i.nombre] = nuevoStock;
        firebaseUpdate(firebaseRef(firebaseDB), {
          [`inventario/${i.nombre}`]: nuevoStock
        });
      }
    });
  });

  const total = document.getElementById('total').textContent;
// Mensaje para el vendedor
const mensajeCliente = `Hola, soy ${datosCliente.nombre}, este es mi n√∫mero: ${datosCliente.celular}
He realizado una compra y pagu√© por transferencia.
${detallePedido}
Total: $${total}
Adjunto comprobante: `;

// Mensaje para el administrador (t√∫)
const mensajeAdmin = `üö® NUEVA ORDEN DE COMPRA üö®

üë§ Cliente: ${datosCliente.nombre}
üì± Celular: ${datosCliente.celular}
üí≥ Pago: Transferencia
üßæ Pedido:
${carrito.map(i => `‚Ä¢ ${i.cantidad} x ${i.nombre} ($${i.precio})`).join('\n')}

üí∞ Total: $${total}
`;

// Mostrar datos de pago al cliente
alert(`N√∫mero de cuenta: 4152-3138-5188-0034\nBanco: BBVA\nTitular: Christian Martin\n\nUna vez realizado el dep√≥sito, por favor env√≠a el comprobante para validar tu compra.`);

// Abrir WhatsApp para cliente > vendedor
const urlVendedor = `whatsapp://send?phone=529993526178&text=${encodeURIComponent(mensajeCliente)}`;
window.open(urlVendedor, '_blank');


// Registrar venta en Firebase
carrito.forEach(item => {
const venta = {
  fecha: new Date().toLocaleString(),
  cliente: datosCliente.nombre,
  celular: datosCliente.celular,
  metodo: 'Transferencia',   // opcional: corrige el m√©todo
  producto: item.nombre,
  cantidad: item.cantidad,
  precio: item.precio,
  estatus: 'pendiente',      // ‚Üê agrega esta coma
  entregado: false
};;

  const nuevaRef = firebaseRef(firebaseDB, 'historialVentas/' + Date.now() + '_' + Math.random().toString(36).substr(2, 5));
  firebaseSet(nuevaRef, venta);
});

finalizarPedido();

}

function pagarEfectivo() {
  document.getElementById('metodoPagoModal').style.display = 'none';

  let detallePedido = '';
  carrito.forEach(i => {
    detallePedido += `- ${i.cantidad} x ${i.nombre} ($${i.precio})\n`;

    const refItem = firebaseRef(firebaseDB, `inventario/${i.nombre}`);
    firebaseGet(refItem).then(snapshot => {
      if (snapshot.exists()) {
        const actual = parseInt(snapshot.val()) || 0;
        const nuevoStock = Math.max(0, actual - i.cantidad);
        inventario[i.nombre] = nuevoStock;
        firebaseUpdate(firebaseRef(firebaseDB), {
          [`inventario/${i.nombre}`]: nuevoStock
        });
      }
    });
  });

  const total = document.getElementById('total').textContent;
// Mensaje para el vendedor
const mensajeCliente = `Hola, soy ${datosCliente.nombre}, este es mi n√∫mero: ${datosCliente.celular}
He realizado un pedido y pagar√© en efectivo.
${detallePedido}
Total: $${total}`;

// Mensaje para el administrador (t√∫)
const mensajeAdmin = `üßæ NUEVO PEDIDO EFECTIVO üßæ

üë§ Cliente: ${datosCliente.nombre}
üì± Celular: ${datosCliente.celular}
üí∞ Pago: Efectivo
üßä Pedido:
${carrito.map(i => `‚Ä¢ ${i.cantidad} x ${i.nombre} ($${i.precio})`).join('\n')}

üíµ Total: $${total}
`;

// Mostrar alerta al cliente
alert("Perfecto, tu pedido ha sido registrado con pago en efectivo.");

// WhatsApp para vendedor
const urlVendedor = `whatsapp://send?phone=529993526788&text=${encodeURIComponent(mensajeCliente)}`;
window.open(urlVendedor, '_blank');


// Registrar venta en Firebase
carrito.forEach(item => {
const venta = {
  fecha: new Date().toLocaleString(),
  cliente: datosCliente.nombre,
  celular: datosCliente.celular,
  metodo: 'Efectivo',
  producto: item.nombre,
  cantidad: item.cantidad,
  precio: item.precio,
  estatus: 'pendiente',
};

  const nuevaRef = firebaseRef(firebaseDB, 'historialVentas/' + Date.now() + '_' + Math.random().toString(36).substr(2, 5));
  firebaseSet(nuevaRef, venta);
});

finalizarPedido();

}

function finalizarPedido() {
  actualizarVentas();
  carrito.length = 0;
  localStorage.removeItem('carritoBolis');
  actualizarCarrito();
}


function iniciarSesion() {
  const u = document.getElementById('usuario').value;
  const c = document.getElementById('contrasena').value;
  if (u === 'Jleon' && c === 'Password1') {
    localStorage.setItem('sesionActiva', '1');
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('logoutContainer').style.display = 'block';
    crearCamposInventario();
    cargarHistorialVentas(); // ‚úÖ Agrega esta l√≠nea aqu√≠
    document.getElementById('historialBoton').style.display = 'block';

  } else {
    alert("Credenciales incorrectas");
  }
}


function verificarSesion() {
  // Escuchar los cambios en tiempo real desde Firebase
  firebaseOnValue(firebaseRef(firebaseDB, 'inventario'), (snapshot) => {
    const datosFirebase = snapshot.val();
    if (datosFirebase) {
      Object.keys(datosFirebase).forEach(nombre => {
        inventario[nombre] = datosFirebase[nombre];
      });
      renderProductos();
      if (localStorage.getItem('sesionActiva') === '1') {
        crearCamposInventario(); // Para que los inputs se sincronicen con los nuevos datos
        document.getElementById('historialBoton').style.display = 'block';

      }
      localStorage.setItem('inventarioBolis', JSON.stringify(inventario)); // respaldo local
    }
  });

  const carritoGuardado = localStorage.getItem('carritoBolis');
  if (carritoGuardado) {
    const datos = JSON.parse(carritoGuardado);
    datos.forEach(item => carrito.push(item));
    actualizarCarrito();
  }

if (localStorage.getItem('sesionActiva') === '1') {
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('adminPanel').style.display = 'block';
  document.getElementById('logoutContainer').style.display = 'block';
  document.getElementById('historialBoton').style.display = 'block'; // üëà Esta l√≠nea
  crearCamposInventario();
document.getElementById('historialBotonMovil').style.display = 'block';
document.getElementById('logoutContainerMovil').style.display = 'block';
  document.getElementById('publicidadBotonMovil').style.display = 'block';


}


  renderProductos();
}

    function cerrarSesion() {
      localStorage.removeItem('sesionActiva');
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('logoutContainer').style.display = 'none';
    }

    function crearCamposInventario() {
      const inv = document.getElementById('inventarioInputs');
      inv.innerHTML = '';
      sabores.forEach(({ nombre }) => {
        inventario[nombre] = inventario[nombre] ?? 0;
        inv.innerHTML += `<label>${nombre}: <input type="number" data-nombre="${nombre}" value="${inventario[nombre]}"></label>`;
      });
    }

function guardarInventario() {
  document.querySelectorAll('#inventarioInputs input').forEach(input => {
    const nombre = input.dataset.nombre;
    inventario[nombre] = parseInt(input.value) || 0;
  });

  // Guardar en Firebase
  firebaseSet(firebaseRef(firebaseDB, 'inventario'), inventario)
    .then(() => {
      console.log("Inventario guardado en Firebase");
    })
    .catch((error) => {
      console.error("Error al guardar en Firebase:", error);
    });

  // Tambi√©n seguir usando localStorage (por seguridad local)
  localStorage.setItem('inventarioBolis', JSON.stringify(inventario));
  renderProductos();
}

    function actualizarVentas() {
      const cuerpo = document.querySelector('#tablaVentas tbody');
      cuerpo.innerHTML = '';
      ventas.forEach(v => {
        const sub = v.precio * v.cantidad;
        cuerpo.innerHTML += `<tr><td>${v.nombre}</td><td>$${v.precio}</td><td>${v.cantidad}</td><td>$${sub.toFixed(2)}</td></tr>`;
      });
    }

    function toggleLogin() {
      const login = document.getElementById('loginContainer');
      login.style.display = login.style.display === 'block' ? 'none' : 'block';
      if (login.style.display === 'block') login.scrollIntoView();
    }


function mostrarHistorialVentas() {
  document.getElementById('historialVentas').style.display = 'block';
  // Si no se han tocado fechas, rellena con hoy (solo visual)
  if (soloHoyPorDefecto) {
    const hoy = hoyYYYYMMDD();
    document.getElementById('fechaInicio').value = hoy;
    document.getElementById('fechaFin').value = hoy;
  }
  cargarHistorialVentas(); // ‚Üê recarga puntual seg√∫n el rango actual
}





function filtrarHistorial() {
  const texto = document.getElementById('filtroBusqueda').value.toLowerCase();
  const filas = document.querySelectorAll('#tablaHistorialBody tr');
  filas.forEach(fila => {
    const contenido = fila.textContent.toLowerCase();
    fila.style.display = contenido.includes(texto) ? '' : 'none';
  });
}


function filtrarPorFechas() {
  const inicio = document.getElementById('fechaInicio').value;
  const fin    = document.getElementById('fechaFin').value;

  // Si no hay filtros, volvemos al modo "solo hoy"
  soloHoyPorDefecto = (!inicio && !fin);

  // Reconstruye la tabla y recalcula totales
  cargarHistorialVentas();
}





function cargarHistorialVentas() {
  const tablaBody = document.getElementById('tablaHistorialBody');
  tablaBody.innerHTML = '';
  document.getElementById('historialVentas').style.display = 'block';

  if (soloHoyPorDefecto) {
    const hoy = hoyYYYYMMDD();
    document.getElementById('fechaInicio').value = hoy;
    document.getElementById('fechaFin').value = hoy;
  }

  const inicio = document.getElementById('fechaInicio').value || (soloHoyPorDefecto ? hoyYYYYMMDD() : '');
  const fin    = document.getElementById('fechaFin').value    || (soloHoyPorDefecto ? hoyYYYYMMDD() : '');

  const ventasRef = firebaseRef(firebaseDB, 'historialVentas');

  // Trae el snapshot UNA sola vez seg√∫n el rango actual
  firebaseGet(ventasRef).then(snapshot => {
    const datos = snapshot.val();
    if (!datos) {
      tablaBody.innerHTML = '<tr><td colspan="10">No hay ventas registradas.</td></tr>';
      document.getElementById('totalProductosVendidos').textContent = 0;
      document.getElementById('dineroIngresado').textContent = '0.00';
      return;
    }

    let totalProductos = 0;
    let totalDinero = 0;
    tablaBody.innerHTML = '';

    Object.entries(datos).forEach(([idVenta, v]) => {
      const fechaISO = fechaTextoAISO(v.fecha);

      const usarFiltro = soloHoyPorDefecto || inicio || fin;
      if (usarFiltro) {
        const dentro = (!inicio || fechaISO >= inicio) && (!fin || fechaISO <= fin);
        if (!dentro) return;
      }

      const entregado = v.entregado === true;
      const botonEntregaColor = entregado ? '#16a34a' : '#ef4444';
      const botonEntregaLabel = entregado ? 'Entregado' : 'No entregado';

      const fila = `
        <tr>
          <td>${v.fecha}</td>
          <td>${v.cliente || ''}</td>
          <td>${v.celular || ''}</td>
          <td>${v.metodo || ''}</td>
          <td>${v.producto || ''}</td>
          <td>${v.cantidad || 0}</td>
          <td>$${v.precio || 0}</td>
          <td>$${(((+v.precio)||0) * ((+v.cantidad)||0)).toFixed(2)}</td>
          <td>
            <button onclick="marcarComoPagado('${idVenta}')" style="background-color: ${v.estatus === 'pagado' ? '#16a34a' : '#facc15'}; color: black; border: none; border-radius: 6px; padding: 4px 8px;">
              ${v.estatus === 'pagado' ? 'Pagado' : 'Pendiente'}
            </button>
          </td>
          <td>
            <button onclick="toggleEntrega('${idVenta}', ${entregado})" style="background-color: ${botonEntregaColor}; color: white; border: none; border-radius: 6px; padding: 4px 8px;">
              ${botonEntregaLabel}
            </button>
          </td>
        </tr>
      `;
      tablaBody.innerHTML += fila;

      totalProductos += Number(v.cantidad) || 0;
      totalDinero += (Number(v.cantidad) || 0) * (Number(v.precio) || 0);
    });

    document.getElementById('totalProductosVendidos').textContent = totalProductos;
    document.getElementById('dineroIngresado').textContent = totalDinero.toFixed(2);
  }).catch(err => {
    console.error('Error cargando historial:', err);
    tablaBody.innerHTML = '<tr><td colspan="10">Error al cargar historial.</td></tr>';
  });
}





function marcarComoPagado(idVenta) {
  const confirmacion = confirm("¬øConfirmas que esta venta ya fue pagada?");
  if (!confirmacion) return;

  const ventaRef = firebaseRef(firebaseDB, 'historialVentas/' + idVenta);
  firebaseUpdate(ventaRef, { estatus: 'pagado' })
    .then(() => {
      alert("Venta marcada como pagada ‚úÖ");
      mostrarHistorialVentas(); // üîÅ vuelve a cargar el historial actualizado
    })
    .catch(err => {
      console.error("Error al actualizar:", err);
      alert("Ocurri√≥ un error al actualizar el estatus.");
    });
}

window.addEventListener('load', () => {
mostrarPopupPublicidad();

});

function togglePublicidad() {
  const editor = document.getElementById('editorPublicidad');
  editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
}

function guardarPublicidad() {
  const titulo = document.getElementById('tituloPublicidad').value;
  const descripcion = document.getElementById('descripcionPublicidad').value;
  const precio = document.getElementById('precioPublicidad').value;
  const imagenes = document.getElementById('imagenesPublicidad').files;

  const readerPromises = Array.from(imagenes).map(file => {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(file);
    });
  });

  Promise.all(readerPromises).then(imagenesBase64 => {
    const publicidad = { titulo, descripcion, precio, imagenes: imagenesBase64 };
    localStorage.setItem('publicidadBolis', JSON.stringify(publicidad));
    alert('Publicidad guardada correctamente');
  });
}

function mostrarPopupPublicidad() {
  const publicidad = JSON.parse(localStorage.getItem('publicidadBolis') || '{}');
  if (!publicidad.titulo || !publicidad.imagenes) return;

  const cont = document.getElementById('contenidoPublicidad');
  cont.innerHTML = `
    <h2>${publicidad.titulo}</h2>
    <p>${publicidad.descripcion}</p>
    <h3>Precio: ${publicidad.precio}</h3>
   <img src="${publicidad.imagenes[0]}" alt="Publicidad" />

  `;
  document.getElementById('popupPublicidad').style.display = 'block';
}

function cerrarPublicidad() {
  document.getElementById('popupPublicidad').style.display = 'none';
}



  </script>
<script>
  function toggleMenu() {
    const menu = document.getElementById('menuMovil');
    menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
  }
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

window.toggleEntrega = function(idVenta, estadoActual) {
  const nuevoEstado = !estadoActual;
  const confirmacion = confirm(
    nuevoEstado
      ? "¬øConfirmas que el boli ya fue entregado?"
      : "¬øConfirmas marcar como No entregado?"
  );
  if (!confirmacion) return;

  const ventaRef = firebaseRef(firebaseDB, 'historialVentas/' + idVenta);
  firebaseUpdate(ventaRef, { entregado: nuevoEstado })
    .then(() => {
      // No hace falta redibujar manualmente si ya tienes onValue;
      // se actualizar√° solo.
      // Si quieres, aqu√≠ puedes mostrar un toast/alert corto.
    })
    .catch(err => {
      console.error('Error al actualizar entrega:', err);
      alert('Ocurri√≥ un error al actualizar el estatus de entrega.');
    });
};

  const firebaseConfig = {
    apiKey: "AIzaSyAnV23rp76MHbkDj1ABueo4JjwcEYBIABo",
    authDomain: "bolis-d62c6.firebaseapp.com",
    projectId: "bolis-d62c6",
    storageBucket: "bolis-d62c6.firebasestorage.app",
    messagingSenderId: "612127107528",
    appId: "1:612127107528:web:f8d72ce368f2a6a7b9f8fd",
    measurementId: "G-WR9Z2MGGXV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.firebaseDB = db;
  window.firebaseRef = ref;
  window.firebaseSet = set;
  window.firebaseGet = get;
  window.firebaseOnValue = onValue;
  window.firebaseUpdate = update;



</script>
  <div id="metodoPagoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;">
  <div style="background:white; padding:20px; border-radius:10px; text-align:center; max-width:300px;">
    <h3>¬øC√≥mo deseas pagar?</h3>
    <p>Selecciona un m√©todo de pago para continuar:</p>
    <button onclick="pagarTransferencia()" style="margin:10px; padding:10px 20px; background:#2a9d8f; color:white; border:none; border-radius:5px;">Transferencia</button>
    <button onclick="pagarEfectivo()" style="margin:10px; padding:10px 20px; background:#4a4a4a; color:white; border:none; border-radius:5px;">Efectivo</button>
  </div>
</div>
<div id="popupPublicidad">
  <span onclick="cerrarPublicidad()" style="float:right; cursor:pointer; font-size:20px; padding:10px;">‚úñÔ∏è</span>
  <div id="contenidoPublicidad" style="text-align:center;"></div>
</div>



</body>
</html>









